endpoints:
  - name: default-endpoint
    request:
      url: https://httpbin.org/anything
      method: POST
      timeout: 10000
      headers:
        x-apikey: secret
    retry:
      strategy: fixed
      config:
        attempts: [0, 3600, 3600]
    events: [ "charge.succeeded" ]

sources:
  - name: github-source
    path: /github
    methods: [ "POST" ]
    response:
      code: 200
      content_type: application/json
      body: '{"message": "OK"}'
    plugins:
      - name: function
        config:
          function: |
            function handle() {
              // verify signature
              var bytes = webhookx.utils.hmac('SHA-256', "secret", webhookx.request.getBody())
              var signature = "sha256=" + webhookx.utils.encode('hex', bytes)
              var signatureHeader = webhookx.request.getHeader("X-Hub-Signature-256")
              console.log(signature)
              if (!webhookx.utils.digestEqual(signature, signatureHeader)) {
                webhookx.response.exit(400, { 'Content-Type': 'application/json' }, { message: 'invalid signature' })
              }
              // transform payload
              try {
                var obj = JSON.parse(webhookx.request.getBody())
                var event_type = webhookx.request.getHeader('X-GitHub-Event') + "." + obj.action
                webhookx.request.setBody(JSON.stringify({ event_type: event_type, data: obj }))
              } catch(e) {
                console.log(e)
                webhookx.response.exit(400, { 'Content-Type': 'application/json' }, { message: 'Invalid JSON' })
              }
            }
