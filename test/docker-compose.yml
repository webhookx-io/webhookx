services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: webhookx_test
      POSTGRES_USER: webhookx
      POSTGRES_HOST_AUTH_METHOD: trust
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}" ]
      interval: 3s
      timeout: 5s
      retries: 3
    ports:
      - "5432:5432"

  redis:
    image: redis:6.2
    command: "--appendonly yes --appendfsync everysec"
    ports:
      - "6379:6379"

  httpbin:
    image: kennethreitz/httpbin
    ports:
      - "9999:80"

  httpsbin:
    image: nginx:latest
    depends_on:
      - httpbin
    ports:
      - "9443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./server.crt:/etc/nginx/certs/server.crt:ro
      - ./server.key:/etc/nginx/certs/server.key:ro

  otel-collector:
    image: otel/opentelemetry-collector-contrib
    volumes:
      - ./otel-collector-config.yml:/etc/otelcol-contrib/config.yaml
      - ./output/otel:/tmp/otel
    ports:
      - "4317:4317"
      - "4318:4318"

  localstack:
    container_name: "localstack"
    image: localstack/localstack
    ports:
      - "4566:4566"
    environment:
      DEBUG: "1"

  vault:
    image: hashicorp/vault:1.21
    container_name: vault
    cap_add:
      - IPC_LOCK
    network_mode: host
    environment:
      VAULT_LOG_LEVEL: debug
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    ports:
      - "8200:8200"
    healthcheck:
      test: [ "CMD-SHELL", "VAULT_ADDR=http://127.0.0.1:8200 vault status" ]
      interval: 3s
      timeout: 5s
      retries: 3

  vault-init:
    image: hashicorp/vault:1.21
    container_name: vault-init
    network_mode: host
    environment:
      VAULT_ADDR: 'http://localhost:8200'
      VAULT_TOKEN: 'root'
    volumes:
      - ./init-vault.sh:/init-vault.sh
    entrypoint: /bin/sh -c "/init-vault.sh"
    depends_on:
      vault:
        condition: service_healthy
